<!--
  ~ Copyright 2018, TeamDev Ltd. All rights reserved.
  ~
  ~ Redistribution and use in source and/or binary forms, with or without
  ~ modification, must retain the above copyright notice and the following
  ~ disclaimer.
  ~
  ~ THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
  ~ "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
  ~ LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
  ~ A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
  ~ OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
  ~ SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
  ~ LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
  ~ DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
  ~ THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
  ~ (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
  ~ OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
  -->
<link rel="import" href="../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../../bower_components/app-route/app-location.html">
<link rel="import" href="../../../bower_components/app-route/app-route.html">
<link rel="import" href="../../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../shell/redux-store.html">
<link rel="import" href="./purchase-order/purchase-order.html">
<link rel="import" href="./purchase-order/purchase-order-details-container.html">

<dom-module id="vendor-orders">
    <template>
        <style>
            paper-tabs {
                -webkit-font-smoothing: antialiased;
                width: 100%;
                margin-bottom: 1px;
                --paper-tabs-selection-bar-color: var(--paper-light-blue-500);
                --paper-tab-ink: var(--paper-light-blue-500);
            }

            paper-tabs {
                margin: 0 auto 1% auto;
            }

            paper-tab.iron-selected .day-of-the-week {
                color: var(--paper-light-blue-500);
            }

            paper-tab.iron-selected .day {
                color: var(--paper-light-blue-500);
            }

            paper-tab .paper-tab-container {
                @apply --layout-horizontal;
                @apply --layout-center-center;
                text-decoration: none;
                color: #323232;
                font-size: 1.5em;
            }

            paper-tab[disabled] .paper-tab-container {
                color: var(--paper-grey-500);
            }

            .disabled .day {
                color: var(--paper-grey-500);
            }

            .disabled .day-of-the-week {
                color: var(--paper-grey-500);
            }

            .day-of-the-week {
                font-size: 0.7em;
                font-weight: lighter;
            }

            .link {
                @apply --layout-horizontal;
                @apply --layout-center-center;
                text-decoration: none;
                color: #4f4f4f;
                font-size: 1.5em;
            }

            paper-icon-button#calendar {
                --paper-icon-button: {
                    background-color: white;
                    border-radius: 50px;
                    box-shadow: 2px 3px 10px rgba(0, 0, 0, 0.5);
                }
            }

            app-datepicker {
                display: none;
                position: absolute;
                z-index: 9999;
                right: 15%;
            }

            #picker {
                --app-datepicker-calendar-bg: white;
                --app-datepicker-selection-bg: var(--paper-light-blue-700);
                --app-datepicker-selection-color: var(--google-grey-100);
                --app-datepicker-iron-selected: var(--google-grey-100);
                --app-datepicker-selected-day-bg: var(--paper-light-blue-700);
                --app-datepicker-today-color: var(--paper-light-blue-500);
                --app-datepicker-date-hover-background-color: var(--paper-light-blue-700);

                --app-datepicker-selected-date: {
                    font-weight: normal;
                    font-size: 22px;
                };

                --app-datepicker-selected-year: {
                    font-weight: normal;
                }
            }

            .header {
                width: 70%;
                margin: 0 auto;
                display: flex;
                justify-content: space-between;
            }

            .header-title {
                margin-left: 15%;
                margin-top: 5%
            }

            @media only screen and (max-width: 1370px) {

            }

            @media only screen and (max-width: 1024px) {
                .header-title {
                    margin-left: 1%;
                    margin-bottom: 0;
                }

                paper-tabs {
                    margin-top: 3%;
                }

                .header {
                    width: 100%;
                    align-items: center;
                }

                app-datepicker {
                    right: 0;
                }

            }

            @media only screen and (max-width: 414px) {
                .header-title {
                    display: none;
                }
            }

        </style>

        <app-location route="{{route}}"
                      use-hash-as-path></app-location>

        <app-route
                route="{{route}}"
                pattern="/:page/:date/:vendor"
                data="{{routeData}}"
                tail="{{subroute}}">
        </app-route>

        <iron-pages
                selected="[[routeData.vendor]]"
                attr-for-selected="name"
                fallback-selection="view404"
                role="main">
            <div name="">
                <h1 class="header-title">Заказ поставщику</h1>
                <div class="header">
                    <paper-tabs id="ptab" class="tabs"
                                selected="1">
                        <paper-tab class="paper-tab" link on-click="_selectPreviousDay">
                            <!--<a href="#/order/[[_previousDay]]/"-->
                            <!--class="paper-tab-container">-->
                            <div>
                                <div class="day">Предыдущий день</div>
                            </div>
                            <!--</a>-->
                        </paper-tab>
                        <paper-tab class="paper-tab" link>
                            <a href="#/order/[[currentDate]]/"
                               class="paper-tab-container">
                                <div>
                                    <!--<div class="day-of-the-week">-->
                                    <!--[[_getDate()]]-->
                                    <!--</div>-->
                                    <!--<div class="day">[[_getDayOfTheWeek()]]</div>-->
                                    [[currentDate]]
                                </div>
                            </a></paper-tab>
                    </paper-tabs>
                    <paper-icon-button id="calendar" icon="today"
                                       on-click="openDatePicker"></paper-icon-button>
                </div>
                <app-datepicker on-date-changed="_calendarDateChanged" id="picker"
                                format="yyyy-mm-dd" view="vertical"
                                input-date="[[inputDate]]" date="{{currentDate}}"
                                auto-update-date="true"
                                locale="ru-RU"></app-datepicker>
                <purchase-order route-data=[[routeData]]
                                current-orders="[[displayedOrders]]"></purchase-order>
            </div>

            <purchase-order-details-container route="{{subroute}}" vendor-data="[[route]]"
                                              name="[[routeData.vendor]]"></purchase-order-details-container>
        </iron-pages>
    </template>
    <script>
        {
            class VendorOrders extends MealOrderAdminApp.ReduxMixin(Polymer.Element) {
                static get is() {
                    return 'vendor-orders';
                }

                static get properties() {
                    return {
                        serverTime: {
                            statePath: 'serverTime'
                        },
                        routeData: {
                            type: Object,
                        },
                        inputDate: {
                            type: String,
                        },
                        currentDate: {
                            type: String,
                        },

                        // _previousDay: {
                        //     type: Object,
                        //     computed: '_getPreviousDay(currentDate)'
                        // },
                        purchaseOrders: {
                            type: Array,
                            statePath: 'purchaseOrders',
                        },
                        selectedDay: {
                            type: String,
                        }
                    };
                }

                static get actions() {
                    return {
                        getSelectedOrders: function (startDate, endDate) {
                            return {
                                type: MealOrderAdminApp.AdminActions.GET_SELECTED_ORDERS,
                                startDate, endDate
                            }
                        }
                    }
                }

                static get observers() {
                    return [
                        '_pageChanged(routeData)',
                    ];
                }

                _selectPreviousDay() {
                    const newRouteData = this.routeData;
                    const date = new Date(newRouteData.date);
                    date.setDate(date.getDate() - 1);
                    const DATE_LENGTH = 10;
                    const newDate = date.toISOString().slice(0, DATE_LENGTH);
                    newRouteData.date = newDate;
                    this.set('routeData', newRouteData);
                    this._pageChanged();
                }

                _getPreviousDay() {
                    const newDate = new Date(this.currentDate);
                    newDate.setDate(newDate.getDate() - 1);
                    const DATE_LENGTH = 10;
                    console.log("@!@!@");
                    return newDate.toISOString().slice(0, DATE_LENGTH);
                }

                _getDay(date) {
                    return date.getDate();
                }

                _getDate() {
                    const DATE_LENGTH = 10;
                    return this.serverTime.toISOString().slice(0, DATE_LENGTH);
                }

                _getDayOfTheWeek() {
                    const dayOfTheWeek = this.serverTime.toLocaleDateString("ru-RU", {weekday: 'short'});
                    return dayOfTheWeek.charAt(0).toUpperCase() + dayOfTheWeek.slice(1);
                }

                _getDisplayedOrder() {
                    const purchaseOrders = this.purchaseOrders;
                    if (purchaseOrders) {
                        return purchaseOrders.filter(order => order.date.getTime() === new Date(this.routeData.date).getTime());
                    }
                }

                _calendarDateChanged(e) {
                    const currentDate = e.target.date;
                    if (this.routeData.date && !this.routeData.vendor) {
                        this.dispatch('getSelectedOrders',);
                        this.set('route.path', '/order/' + currentDate + "/");
                        this.$.picker.style = 'display:none;';
                        this.$.calendar.style.backgroundColor = 'white';
                    }
                }

                _pageChanged() {
                    console.log('1');

                    if (!this.routeData.date) {
                        console.log("!!!");
                        const DATE_LENGTH = 10;
                        const date = this.serverTime.toISOString().slice(0, DATE_LENGTH);
                        this.set('inputDate', date);
                        // const DAYS_IN_PERIOD = 8;
                        // const startDate = new Date(this.serverTime);
                        // startDate.setDate(startDate.getDate() - (DAYS_IN_PERIOD - 1));
                        // this.dispatch('getSelectedOrders', startDate, new Date(this.serverTime));
                        this.set('route.path', '/order/' + date + "/");
                    }
                    else {
                        const date = this.routeData.date;
                        this.set('inputDate', date);
                        this.$.ptab.select(1);
                        this.set('route.path', '/order/' + date + "/");
                    }
                }

                openDatePicker() {
                    if (this.$.picker.style.display !== 'inline') {
                        this.$.calendar.style.backgroundColor = '#0085d3';
                        this.$.picker.style = 'display:inline;';
                    }
                    else {
                        this.$.picker.style = 'display:none;';
                        this.$.calendar.style.backgroundColor = 'white';
                    }
                }
            }

            window.customElements.define(VendorOrders.is, VendorOrders);
        }
    </script>
</dom-module>
